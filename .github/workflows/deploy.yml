name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test Server Connectivity
        run: |
          echo "Testing connection to ${{ secrets.HOST }}..."
          
          # Test port 22
          nc -zv -w10 ${{ secrets.HOST }} 22 || echo "Port 22 not accessible"
          
          # Test với timeout dài hơn
          timeout 30 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.HOST }}/22" && echo "Port 22 is open" || echo "Port 22 is closed or filtered"
          
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            git pull origin main